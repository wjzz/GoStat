\documentclass[10pt,leqno]{article}
\usepackage[polish]{babel}
\usepackage[utf8]{inputenc}
\usepackage[T1]{fontenc}
\frenchspacing
%\usepackage{indentfirst}
\usepackage{listings}
\usepackage{hyperref}
\usepackage{framed}
\usepackage[textwidth=14cm,textheight=24cm]{geometry}

\usepackage{fancyhdr}
\pagestyle{fancy}
%\fancyhf{}
\cfoot{\thepage}
\lhead{\nouppercase{\leftmark}}
\rhead{\nouppercase{\rightmark}}

\newcommand{\cmd}[1]{
  \texttt{#1}
}

\title{\LARGE Licencjacki projekt programistyczny 2011 \\ 
       \ \\
       Program do wykonywania obliczeń statystycznych związanych z grą go \\ 
       \ \\
       Dokumentacja programisty }

% TODO autor wieksza czcionka

\author{Wojciech Jedynak}
\date{Wrocław, \today}

\begin{document}

\maketitle 

\newpage

\tableofcontents

\newpage

\section{Wprowadzenie}

\subsection{Cel dokumentacji}
Celem niniejszego dokumentu jest takie przedstawienie struktury projektu GoStat, aby umożliwić jego modyfikacje oraz utrzymywanie programistom, którzy
znają Haskella, ale nie należeli do początkowego zespołu. Wykaz użytych bibliotek powinien był pomocny, jeśli instalacja oprogrogramowania nie powiedzie 
się i konieczna będzie kompilacja programu ze źródeł. Dodatkowo życzeniem autora jest nakreślenie wykonanej pracy tak, aby zainteresowane osoby
były w stanie (w razie potrzeby) na wykorzystanie opisanych tu rozwiązań w swoich projektach.

\section{Organizacja projektu}

\subsection{Ogólny opis}
Program został napisany niemal w całości w Haskellu. Po uruchomieniu pliku \cmd{GoStat} wewnętrzny serwer HTTP nasłuchuje na porcie 8000, 
a komunikacja z użytkownikiem odbywa się za pomocą interfejsu WWW. 
Lista katalogów, w których znajduje się kolekcja plików SGF, zapisywana jest do pliku konfiguracyjnego,
wstępnie przetworzone (\emph{znormalizowane}) gry są przechowywane w bazie danych. Dialog z użytkownikiem może odbywać się w języku
polskim bądź angielskim.

\subsection{Konfiguracja programu}

W programie potrzebujemy przechowywać dwie informacje: jakiej bazy danych używa (chce używać) użytkownik i gdzie znajduje się jego
kolekcja zapisów partii go, które chciałby analizować naszym programem. Do przechowywania ww. danych używamy bardzo prostego, 
autorskiego formatu. Funkcje związane z wczytywanien, analizą leksykalną oraz zapisywaniem znajdują się w module Configuration 
(w pliku src/Configuration.hs).

\subsubsection{Opis formatu pliku CONFIG}

Format pliku jest opisywany przez poniższą gramatykę w postaci EBNF:
\begin{framed}
\noindent config ::= declaration* \\ 
declaration ::= db | dirs | '--' *anything* \\
db = dbserver ':' dbversion \\ 
dbversion = sqlite3 ';' path ';' | postgresql ';' \\
dirs = gamedirs ':' path ';'
\end{framed}

Przykładowy plik konfiguracyjny:

\begin{framed}
\noindent \--\-- new config \\
\--\--dbserver:postgresql; \\ 
dbserver:sqlite3;/home/wojtekdb/games.db; \\
gamedirs:/home/wojtek/data/;
\end{framed}

%\begin{minipage}[pos]{width} text 
%\end{minipage}



\subsection{Baza danych}

Program pozwala na użycie baz Sqlite3 oraz PostgreSQL. Możliwa jest zmiana decyzji co do tego, która z nich jest używana; 
wymagane jest wówczas przebudowanie zawartości, gdyż protokół komunikacyjny bazy PostgreSQL nie jest kompatybilny z protokołem
bazy Sqlite3. Ani użytkownik ani programista nie muszą zajmować się ręczną administracją bazy danych: służy do tego odpowiedni
moduł (DB w pliku src/DB.hs). 

Używana jest jedna tabela o nazwie go\_stat\_data.

\subsubsection{Tabela go\_stat\_data}

\begin{center}
\textbf{Opis pól tabeli go\_stat\_data}
\renewcommand{\arraystretch}{1.5}
\begin{tabular}{| c | c | c | c | } \hline
 Pole    & Typ          & NULL dozwolone? & Opis                  \\ \hline
 id      & PRIMARY KEY  & nie & unikatowy identyfikator gry       \\ \hline
 winner  & CHAR         & nie & zwycięzca gry ('b' lub 'w')       \\ \hline
 moves   & VARCHAR(700) & nie & znormalizowany przebieg rozgrywki \\ \hline
 path    & VARCHAR(255) & nie & względna scieżka do gry           \\ \hline
 b\_name & VARCHAR(30)  & nie & pseudonim (nazwisko) czarnego     \\ \hline
 w\_name & VARCHAR(30)  & nie & pseudonim (nazwisko) białego      \\ \hline
 b\_rank & VARCHAR(10)  & tak & ranking czarnego                  \\ \hline
 w\_rank & VARCHAR(10)  & tak & ranking białego                   \\ \hline
\end{tabular}

\end{center}

Jedyne pola, która nie są wymagane to pola b\_rank i w\_rank. Wynika to z tego, że na niektórych serwerach do gry w go
nie jest wymagane podanie swojego orientacyjnego poziomu ani rankingu. 

\subsection{Struktura modułów}
Lista modułów wchodzących w skład projektu:

\subsubsection{Data.SGF.Types i Data.SGF.Parsing}

\begin{framed}
\noindent type Move  = (Int, Int) \\
type Moves = [Move] \\
type PlayerName = String \\ 
data Winner     = Black | White \\
data Result = Unfinished | Draw | Win Winner PlayerName \\

\noindent parseSGF :: String -> Either String SGF \\
getResult :: SGF -> Result \\
isWithHandicap :: SGF -> Bool \\
getBlack, getWhite, getBlackRank, getWhiteRank, date :: SGF -> String
\end{framed}

Moduły Data.Sgf.Types i Data.SGF.Parsing zawierają deklaracje typów służących do 
przechowywania informacji o danej partii (m.in. wynik, dane graczy, lista ruchów) oraz funkcje, które
pozwalają dane te wyświetlać i analizować. 

\subsubsection{Transformations}
Przekształcenia matematyczne i normalizacja ruchów

\begin{framed}
\noindent normalizeMoves :: [Move] -> [Move] \\

\noindent isOnMainDiagonal :: Move -> Bool  \\
isAboveMainDiagonal :: Move -> Bool \\
isBelowMainDiagonal :: Move -> Bool \\
isOnHorizontal :: Move -> Bool \\
isAboveHorizontal :: Move -> Bool \\
isBelowHorizontal :: Move -> Bool

\noindent horizontal :: Move -> Move \\
rotate90 :: Move -> Move \\
mainDiagonalMirror :: Move -> Move \\

\noindent transformIntoFirst :: Triangle -> (Move -> Move) \\
getTransformation :: Move -> (Move -> Move) \\

\noindent triangles :: [Triangle] \\
findTriangles :: Move -> [Triangle] \\
findTriangle :: Move -> Triangle
\end{framed}

\subsubsection{SgfBatching}
Konwersja plików SGF do formatu, który będzie łatwo zapisać w bazie danych

\subsubsection{Lang}
Komunikaty w języku polskim i angielskim

\subsubsection{Configuration}
Obsługa pliku CONFIG.

\subsubsection{Pages}
Tworzenie szablonów stron WWW.

\subsubsection{DB}
Zarządzanie bazą danych.

\begin{framed}
\noindent createDB :: GoStatM () \\
deleteDB :: GoStatM () \\
addFilesToDB :: GoStatM () \\
queryCountDB :: GoStatM Int \\
queryStatsDB :: String -> GoStatM [(String, Int, Int, Int)] \\
queryCurrStatsDB :: String -> GoStatM (Int, Int, Int) \\
queryGamesListDB :: String -> Int -> GoStatM [(Int, FilePath, String, String, String, String, String)] \\
queryFindGameById :: Int -> GoStatM (Maybe (String, FilePath))
\end{framed}          

\subsubsection{Server}
Serwer HTTP. 

\subsubsection{Main}
Punkt startowy aplikacji.

% \subsubsection{Offline}



\subsection{Pozostałe pliki}
Pliki css, javascript, obrazki

\section{Kompilacja i testowanie}

\section{Wykorzystane biblioteki i narzędzia pomocnicze}
\subsection{Biblioteki, pakiety, moduły}
\subsubsection{Śledzenie zależności (Cabal)}
\subsubsection{Serwer HTTP (Happstack)}
\subsubsection{Testowanie (HUnit, QuickCheck, test-framework)}
\subsubsection{Zarządzanie bazą danych (HDBC, HDBC-postresql, HDBC-sqlite3)}
\subsubsection{Analiza leksykalna (Parsec)}
\subsubsection{Generowanie html (xhtml 3000)}
\subsubsection{Pozostałe (filemanip, strict, mtl)}

\subsection{Narzędzia}
W niniejszej sekcji wymieniono i pokrótce opisano najważniejsze narzędzia, które pozwoliły ukończyć projekt.

\subsubsection{Git i portal http://github.com}
Git to system do kontroli wersji autorstwa Linuxa Torwardsa (TODO: sprawdzić pisownię). Github to portal, który pozwala
na przechowywanie kodu źródłowego (ogólnie: repozytoriów kodu zarządzanych przez git) i udostępnienie go innym programistom.
Poprzez użycie tych zasobów rozwiązałem kwestię składowania projektu i mogłem swobodnie eksperymentować: nietrafione zmiany
można było wycofać jednym poleceniem.

\subsubsection{Latex}
System \LaTeX pozwolił na utworzenie dokumentacji w formacie pdf, który jest standardem w informatyce.

%% 2.0. Organizacja projektu
%% 2.0.0. Cykl życia aplikacji
%% 2.0.1. Struktura modułów
%% 2.0.2. Baza danych
%% 2.0.3. Automatycznie generowana dokumentacja (API)
%% 2.1. Kompilacja i testowanie projektu - konkretne polecenia
%% 2.2. Omowienie modulow
%% 2.2.1. Data.SGF
%% 2.2.2. Transformations (opis funkcji i niezmiennikow)

\begin{thebibliography}{9}

\bibitem{git}
  \emph{Git -- narzędzie do kontroli wersji} \\
  \url{http://git-scm.com/}

\bibitem{github}
  \emph{Portal github.com} \\
  \url{https://github.com/}

\bibitem{wjzz}
  \emph{Repozytorium projektu GoStat w portalu github} \\
  \url{https://github.com/wjzz}

\bibitem{sqlite3}
  \emph{SQLite3 -- lekka baza danych} \\
  \url{http://www.sqlite.org/}

\bibitem{jquery}
  \emph{jQuery -- biblioteka dla JavaScriptu} \\
  \url{http://jquery.com/}

\bibitem{jqueryui}
  \emph{jQuery IU -- biblioteka komponentów dla JavaScriptu} \\
  \url{http://jqueryui.com/}

\bibitem{eidogo}
  \emph{Eidogo -- interaktywna plansza} \\
  \url{http://eidogo.com/source}

\bibitem{haskell}
  \emph{Haskell -- strona główna} \\
  \url{http://www.haskell.org/}

\bibitem{ghc}
  \emph{Glasgow Haskell Compiler} \\
  \url{http://www.haskell.org/ghc/}

\bibitem{hackage}
  \emph{Hackage -- kolekcja pakietów Haskellowych} \\
  \url{http://hackage.haskell.org/}

\bibitem{cabal}
  \emph{Cabal -- narzędzie do tworzenia i instalowania pakietów Haskellowych} \\
  \url{http://www.haskell.org/cabal/}

\bibitem{happstack}
  \emph{Happstack -- serwer HTTP dla Haskella} \\
  \url{http://happstack.com/index.html}

\bibitem{xhtml}
  \emph{Biblioteka xhtml dla Haskella} \\
  \url{http://hackage.haskell.org/package/xhtml-3000.2.0.1}

\end{thebibliography}


\end{document}
